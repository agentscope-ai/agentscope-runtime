# =================================================================
# Stage 1: adb-mcp builder
# =================================================================
FROM docker:28-dind AS node-builder

RUN apk update && apk add --no-cache nodejs-lts npm

WORKDIR /app/node_app
COPY src/agentscope_runtime/sandbox/box/mobile/adbmcp/package*.json ./

# Install all dependencies and build the application
RUN npm install
COPY src/agentscope_runtime/sandbox/box/mobile/adbmcp/ .
RUN npm run build

# Create a clean production-only package
RUN mkdir -p /prod_bundle && \
    cp -r dist/* /prod_bundle/ && \
    cp package*.json /prod_bundle/ && \
    cd /prod_bundle && \
    npm install --production

# =================================================================
# Stage 2: ws-scrcpy builder
# =================================================================
FROM docker:28-dind AS ws-scrcpy-builder

RUN apk update && apk add --no-cache \
    nodejs-lts npm git python3 build-base

WORKDIR /app
ARG WS_SCRCPY_COMMIT_SHA=ef273d97c6ac0c05d03b41d4b55d59a25b95c505
RUN git clone https://github.com/NetrisTV/ws-scrcpy.git \
    && cd ws-scrcpy \
    && git checkout ${WS_SCRCPY_COMMIT_SHA}

WORKDIR /app/ws-scrcpy
COPY src/agentscope_runtime/sandbox/box/mobile/box/index.ts /app/ws-scrcpy/src/app/index.ts

# Install all dependencies and build the application
RUN npm install && npm run dist

# Create a clean production-only package
RUN mkdir -p /prod_bundle && \
    cp -r dist/* /prod_bundle/ && \
    cd /prod_bundle && \
    npm install --production

# =================================================================
# Final Stage: Production Image
# =================================================================
FROM docker:28-dind

# 1. Install system dependencies
RUN apk update && \
    apk add --no-cache \
        bash nginx supervisor python3 py3-pip gettext coreutils \
        pngquant android-tools nginx-mod-http-lua \
        nodejs-lts

# 2. Install Python application
WORKDIR /app/python_app
COPY src/agentscope_runtime/sandbox/box/shared/ .
COPY src/agentscope_runtime/sandbox/box/mobile/box/requirements.txt .
RUN python3 -m venv .venv && \
    . .venv/bin/activate && \
    pip install --no-cache-dir -r requirements.txt && \
    rm requirements.txt

# 3. Copy the clean production package for adb-mcp
WORKDIR /app/node_app
COPY --from=node-builder /prod_bundle/ ./

# 4. Copy the clean production package for ws-scrcpy
WORKDIR /app/ws-scrcpy
COPY --from=ws-scrcpy-builder /prod_bundle/ ./

# 5. Copy configuration and startup scripts
WORKDIR /
COPY src/agentscope_runtime/sandbox/box/mobile/box/config/supervisord.conf.template /etc/supervisor/supervisord.conf.template
COPY src/agentscope_runtime/sandbox/box/mobile/box/config/nginx.conf.template /etc/nginx/nginx.conf.template
COPY src/agentscope_runtime/sandbox/box/mobile/box/mcp_server_configs.json /app/python_app/mcp_server_configs.json
COPY src/agentscope_runtime/sandbox/box/mobile/box/scripts/start.sh /start.sh
RUN chmod +x /start.sh

RUN echo "[BUILD NOTE] This step requires:" && \
    echo "  'src/agentscope_runtime/sandbox/box/mobile/redroid.tar'." && \
    echo "This file is generated by the build script ('build.py')." && \
    echo "If building manually, please prepare the necessary files."
# 6. Copy the offline redroid image prepared by the build script
# NOTE: The build.py script is responsible for creating this file in the build context.
COPY src/agentscope_runtime/sandbox/box/mobile/redroid.tar /redroid.tar

# 7. Set entrypoint
ENTRYPOINT ["/start.sh"]
