<!doctype html>
<html class="no-js" lang="en" data-content_root="../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="../genindex.html"><link rel="search" title="Search" href="../search.html"><link rel="next" title="Environment Manager" href="environment_manager.html"><link rel="prev" title="9. Manager Module" href="manager.html">
        <link rel="prefetch" href="../_static/logo.svg" as="image">

    <link rel="shortcut icon" href="../_static/logo.svg"><!-- Generated with Sphinx 7.4.7 and Furo 2025.09.25 -->
        <title>Context Manager - AgentScope Runtime</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=d75fae25" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=aadf46a8" />
    
    


<style>
  body {
    --color-code-background: #f0f0f0;
  --color-code-foreground: black;
  --color-brand-primary: #2196f3;
  --color-brand-content: #2196f3;
  --color-admonition-background: #f8f9fa;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #64b5f6;
  --color-brand-content: #64b5f6;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  --color-brand-primary: #64b5f6;
  --color-brand-content: #64b5f6;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="intro.html"><div class="brand"><span style='font-weight: 700; color: #2196f3;'>AgentScope</span> <br><span style='font-weight: 900; color: #ff5722;'>Runtime</span></div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><div class="sidebar-scroll"><a class="sidebar-brand" href="intro.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../_static/logo.svg" alt="Logo"/>
  </div>
  
  <span class="sidebar-brand-text"><span style='font-weight: 700; color: #2196f3;'>AgentScope</span> <br><span style='font-weight: 900; color: #ff5722;'>Runtime</span></span>
  
</a><div class="language-switch">
    <div class="language-selector">
        <button class="language-button" onclick="toggleLanguageMenu()">
            <span id="current-lang">English</span>
            <span class="dropdown-arrow"></span>
        </button>
        <div class="language-menu" id="language-menu">
            <a href="#" class="language-option" onclick="switchLanguage('en')">English</a>
            <a href="#" class="language-option" onclick="switchLanguage('zh')">中文</a>
        </div>
    </div>

    <div class="language-selector">
        <button class="language-button" onclick="toggleVersionMenu()">
            <span id="current-version">loading...</span>
            <span class="dropdown-arrow"></span>
        </button>
        <div class="language-menu" id="version-menu">
        </div>
    </div>
</div>

<script>
    function toggleLanguageMenu() {
        const menu = document.getElementById('language-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function switchLanguage(lang, skipRedirect = false) {
        // Save language preference
        localStorage.setItem('preferred-language', lang);

        // Update displayed language const
        currentLang = document.getElementById('current-lang');
        currentLang.textContent = lang === 'zh' ? '中文' : 'English';
        document.body.setAttribute('data-current-lang', lang);
        if (!skipRedirect) {
            const currentPath = window.location.pathname;
            let newPath = null;

            if (lang === 'zh' && currentPath.includes('/en/')) {
                newPath = currentPath.replace('/en/', '/zh/');
            } else if (lang === 'en' && currentPath.includes('/zh/')) {
                newPath = currentPath.replace('/zh/', '/en/');
            }
            if (newPath && newPath !== currentPath) {
                window.location.href = newPath + window.location.search + window.location.hash;
                return;
            }
        }

        // Apply language filtering
        filterContentByLanguage(lang);

        // Close dropdown menu
        document.getElementById('language-menu').style.display = 'none';
    }

    function filterContentByLanguage(lang) {
        const captions = document.querySelectorAll('.caption');
        const toctreeItems = document.querySelectorAll('.toctree-l1');

        // Define which captions should be displayed based on the selected language
        const languageMapping = {
            'en': ['Tutorial', 'API Reference' ],
            'zh': ['简介', '教程', 'API 参考']
        };

        const visibleCaptions = languageMapping[lang] || [];

        // Filter captions based on the selected language
        captions.forEach(caption => {
            const text = caption.textContent.trim();
            caption.style.display = visibleCaptions.includes(text) ? 'block' : 'none';
        });

        // Filter toctree items based on the selected language
        toctreeItems.forEach(item => {
            const link = item.querySelector('a');
            if (link) {
                const href = link.getAttribute('href') || '';
                if (lang === 'zh') {
                    const hasZh = href.includes('/zh/');
                    const hasEn = href.includes('/en/');
                    const isRelative = !href.startsWith('http') && !href.startsWith('/') && !hasEn;

                    item.style.display = (hasZh || isRelative) ? 'block' : 'none';
                } else {
                    const hasZh = href.includes('/zh/');
                    item.style.display = hasZh ? 'none' : 'block';
                }
            } else {
                item.style.display = 'block';
            }
        });
    }

    document.addEventListener('click', function (e) {
        if (!e.target.closest('.language-selector')) {
            document.getElementById('language-menu').style.display = 'none';
        }
    });
</script><style>
.preview-banner {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background-color: #fff8e7;
    color: #333;
    text-align: center;
    padding: 12px 50px;
    font-size: 14px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    z-index: 9999;
    animation: slideDown 0.3s ease;
    line-height: 1.5em;
    border-bottom: 1px solid #f0e4d5;
}
.preview-banner strong {
    color: #d9534f;
}
.preview-banner-close {
    position: fixed;
    right: 20px;
    top: 10px;
    cursor: pointer;
    font-size: 14px;
    font-weight: bold;
    color: #d9534f;
    background-color: #fff;
    border: 1px solid #f0d9c3;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
    z-index: 10000;
}

.preview-banner-close:hover {
    background-color: #d9534f;
    color: #fff;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
@keyframes slideDown {
    from { transform: translateY(-100%); }
    to { transform: translateY(0); }
}
body.preview-active {
    padding-top: 50px;
}
</style>

<script>
    const VERSIONS = ["preview", "v0.2.0", "v0.1.6", "v0.1.5", "v0.1.4"];
    const VERSION_PATTERN = /^\/(v\d+\.\d+\.\d+)\//;

    function populateVersionMenu() {
        const menu = document.getElementById("version-menu");
        menu.innerHTML = "";

        VERSIONS.forEach(version => {
            const anchor = document.createElement("a");
            anchor.href = "#";
            anchor.className = "language-option";
            anchor.textContent = version;
            anchor.onclick = (e) => {
                e.preventDefault();
                switchVersion(version);
            };
            menu.appendChild(anchor);
        });
    }

    function toggleVersionMenu() {
        const menu = document.getElementById("version-menu");
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    }

    function switchVersion(targetVersion) {
        const currentPath = window.location.pathname;
        let newPath = currentPath;

        document.getElementById("version-menu").style.display = "none";

        const langMatch = currentPath.match(/\/(en|zh)\//);

        if (targetVersion === "preview") {
            if (VERSION_PATTERN.test(currentPath)) {
                newPath = currentPath.replace(VERSION_PATTERN, "/");
            } else {
                newPath = currentPath;
            }
        } else {
            if (VERSION_PATTERN.test(currentPath)) {
                newPath = currentPath.replace(VERSION_PATTERN, `/${targetVersion}/`);
            } else {
                newPath = currentPath.replace(/\/(en|zh)\//, `/${targetVersion}/$1/`);
            }
        }

        const newUrl = newPath + window.location.search + window.location.hash;
        window.location.href = newUrl;
    }

    document.addEventListener("click", function (e) {
        if (!e.target.closest(".language-selector")) {
            document.getElementById("version-menu").style.display = "none";
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        populateVersionMenu();

        const currentPath = window.location.pathname;
        let detectedVersion = "preview";

        const match = currentPath.match(VERSION_PATTERN);
        if (match) {
            detectedVersion = match[1];
        }

        const versionSpan = document.getElementById("current-version");
        if (versionSpan) {
            versionSpan.textContent = detectedVersion;
        }

        if (detectedVersion === "preview") {
            document.body.classList.add("preview-active");

            const langMatch = currentPath.match(/\/(en|zh)\//);
            let bannerText = "";

            if (langMatch && langMatch[1] === "zh") {
                bannerText = `
                    您当前浏览的是 <strong>Cookbook 教程文档的 Preview 版本</strong>（对应 GitHub main 分支）。<br>
                    内容可能会随时更新。如果需要参考 <strong>PyPI 稳定版本的文档</strong>，请使用左侧版本切换栏进行切换。
                    <span class="preview-banner-close" title="关闭">×</span>
                `;
            } else {
                bannerText = `
                    You are viewing the <strong>Preview version of the Cookbook tutorial</strong> (GitHub main branch).<br>
                    Content may change frequently. For the <strong>stable PyPI release documentation</strong>, please use the version switcher on the left.
                    <span class="preview-banner-close" title="Close">×</span>
                `;
            }

            const banner = document.createElement("div");
            banner.className = "preview-banner";
            banner.innerHTML = bannerText;
            document.body.appendChild(banner);

            banner.querySelector(".preview-banner-close").onclick = () => {
                banner.remove();
                document.body.classList.remove("preview-active");
            };
        }
    });
</script><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Tutorial</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">1. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="concept.html">2. Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">3. Quick Start</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="sandbox.html">4. Tool Sandbox</a><input aria-label="Toggle navigation of 4. Tool Sandbox" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="sandbox_advanced.html">Advanced Usage of Tool Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="training_sandbox.html">Training Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="sandbox_troubleshooting.html">Sandbox Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="advanced_deployment.html">5. Advanced Deployment Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="react_agent.html">6. Deploy a ReAct Agent with Tool Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="agent_app.html">7. Deep Dive into AgentApp</a></li>
<li class="toctree-l1"><a class="reference internal" href="protocol.html">8. Agent API Protocol Specification</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="manager.html">9. Manager Module</a><input aria-label="Toggle navigation of 9. Manager Module" checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul class="current">
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Context Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="environment_manager.html">Environment Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="tracing.html">10. Tracing Method Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="demohouse.html">11. Demo House</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="contribute.html">12. How to Contribute</a><input aria-label="Toggle navigation of 12. How to Contribute" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="README.html">Contribute to Cookbook</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="api/index.html">API Reference</a><input aria-label="Toggle navigation of API Reference" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="api/sandbox.html">Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="api/engine.html">Engine</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">简介</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../zh/intro.html">0. 介绍</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">教程</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../zh/install.html">1. 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/concept.html">2. 概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/quickstart.html">3. 快速开始</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../zh/sandbox.html">4. 工具沙箱</a><input aria-label="Toggle navigation of 4. 工具沙箱" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../zh/sandbox_advanced.html">工具沙箱高级用法</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zh/training_sandbox.html">训练用沙箱</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zh/sandbox_troubleshooting.html">沙盒故障排除</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../zh/advanced_deployment.html">5. 高级部署指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/react_agent.html">6. 部署配备工具沙箱的ReAct智能体</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/agent_app.html">7. 深入了解AgentApp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/protocol.html">8. Agent API 协议规范</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../zh/manager.html">9. 管理器模块（Manager Module）</a><input aria-label="Toggle navigation of 9. 管理器模块（Manager Module）" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../zh/context_manager.html">上下文管理器 (Context Manager)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zh/environment_manager.html">环境管理器（Environment Manager）</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../zh/tracing.html">10. 执行轨迹追踪</a></li>
<li class="toctree-l1"><a class="reference internal" href="../zh/demohouse.html">11. Demo 展示厅</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../zh/contribute.html">12. 如何贡献</a><input aria-label="Toggle navigation of 12. 如何贡献" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../zh/README.html">参与贡献Cookbook</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API 参考</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../zh/api/index.html">API 参考</a><input aria-label="Toggle navigation of API 参考" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><span class="icon"><svg><use href="#svg-arrow-right"></use></svg></span></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../zh/api/sandbox.html">Sandbox</a></li>
<li class="toctree-l2"><a class="reference internal" href="../zh/api/engine.html">Engine</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/agentscope-ai/agentscope-runtime/blob/main/cookbook/en/context_manager.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="context-manager">
<h1>Context Manager<a class="headerlink" href="#context-manager" title="Link to this heading">¶</a></h1>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>Context Manager provides a convenient way to manage the context lifecycle.
It consists of:</p>
<ul class="simple">
<li><p>a set of context services (session history, memory)</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">ContextComposer</span></code> to orchestrate history and memory updates</p></li>
</ul>
</section>
<section id="services">
<h2>Services<a class="headerlink" href="#services" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">services</span></code> in context manager are those that are required for the context.
For example, if you want to use the context manager to manage the session history, you need to add the <code class="docutils literal notranslate"><span class="pre">SessionHistoryService</span></code> to the services list.</p>
<p>We provide some basic built-in services for you to use.
And you can also create your own services.</p>
<p>Here are the built-in services:</p>
<section id="sessionhistoryservice">
<h3>SessionHistoryService<a class="headerlink" href="#sessionhistoryservice" title="Link to this heading">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">SessionHistoryService</span></code> is a base class to manage the session history.
It contains the following methods</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">create_session</span></code>: create a new session</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">get_session</span></code>: get a session</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">delete_session</span></code>: delete a session</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">list_sessions</span></code>: list all sessions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">append_message</span></code>: append a message to the history</p></li>
</ul>
<p>Since the <code class="docutils literal notranslate"><span class="pre">SessionHistoryService</span></code> is a base class, use a concrete implementation instead.
For example, we provide an <code class="docutils literal notranslate"><span class="pre">InMemorySessionHistoryService</span></code> to store history in memory. For details, see <a class="reference internal" href="#session-history-service"><span class="std std-ref">here</span></a></p>
</section>
<section id="memoryservice">
<h3>MemoryService<a class="headerlink" href="#memoryservice" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">MemoryService</span></code> is a basic class to manage the memory.
In Agent, memory stores previous conversation of an end-user.
For example, an end-user may mention their name in a previous conversation.
The memory service will store it so that the agent can use it in the next conversation.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">MemoryService</span></code> contains the following methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">add_memory</span></code>: add a memory to the memory service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">search_memory</span></code>: search a memory from the memory service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">delete_memory</span></code>: delete a memory from the memory service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">list_memory</span></code>: list all memories</p></li>
</ul>
<p>Like <code class="docutils literal notranslate"><span class="pre">SessionHistoryService</span></code>, prefer using a concrete implementation such as <code class="docutils literal notranslate"><span class="pre">InMemoryMemoryService</span></code>. For details, see <a class="reference internal" href="#memory-service"><span class="std std-ref">here</span></a></p>
</section>
</section>
<section id="life-cycle-of-a-context-manager">
<h2>Life-cycle of a context manager<a class="headerlink" href="#life-cycle-of-a-context-manager" title="Link to this heading">¶</a></h2>
<p>The context manager can be initialized by two ways:</p>
<section id="initialize-an-instance-directly">
<h3>Initialize an instance directly<a class="headerlink" href="#initialize-an-instance-directly" title="Link to this heading">¶</a></h3>
<p>The simplest way is to initialize an instance directly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.context_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextManager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionHistoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="n">session_history_service</span> <span class="o">=</span> <span class="n">InMemorySessionHistoryService</span><span class="p">()</span>
<span class="n">memory_service</span> <span class="o">=</span> <span class="n">InMemoryMemoryService</span><span class="p">()</span>
<span class="n">context_manager</span> <span class="o">=</span> <span class="n">ContextManager</span><span class="p">(</span>
    <span class="n">session_history_service</span><span class="o">=</span><span class="n">session_history_service</span><span class="p">,</span>
    <span class="n">memory_service</span><span class="o">=</span><span class="n">memory_service</span>
<span class="p">)</span>

<span class="c1"># use the manager</span>
<span class="k">async</span> <span class="k">with</span> <span class="n">context_manager</span> <span class="k">as</span> <span class="n">services</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">services</span><span class="o">.</span><span class="n">compose_session</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">services</span><span class="o">.</span><span class="n">compose_context</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">request_input</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="use-the-async-factory-helper">
<h3>Use the async factory helper<a class="headerlink" href="#use-the-async-factory-helper" title="Link to this heading">¶</a></h3>
<p>We provide a factory function to create a context manager.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.context_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_context_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionHistoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="k">async</span> <span class="k">with</span> <span class="n">create_context_manager</span><span class="p">(</span>
    <span class="n">session_history_service</span><span class="o">=</span><span class="n">InMemorySessionHistoryService</span><span class="p">(),</span>
    <span class="n">memory_service</span><span class="o">=</span><span class="n">InMemoryMemoryService</span><span class="p">(),</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">compose_session</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">compose_context</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">request_input</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="contextcomposer">
<h2>ContextComposer<a class="headerlink" href="#contextcomposer" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ContextComposer</span></code> is a class to compose the context.
It will be called by the context manager when the context is created.
The <code class="docutils literal notranslate"><span class="pre">ContextComposer</span></code> contains a static method:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">compose</span></code>: compose the context</p></li>
</ul>
<p>It provides a sequential composition method and can be overridden by subclasses.</p>
<p>Pass a custom composer class to <code class="docutils literal notranslate"><span class="pre">ContextManager</span></code> when initializing.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.context_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContextManager</span><span class="p">,</span> <span class="n">ContextComposer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionHistoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="k">async</span> <span class="k">with</span> <span class="n">ContextManager</span><span class="p">(</span>
    <span class="n">session_history_service</span><span class="o">=</span><span class="n">InMemorySessionHistoryService</span><span class="p">(),</span>
    <span class="n">memory_service</span><span class="o">=</span><span class="n">InMemoryMemoryService</span><span class="p">(),</span>
    <span class="n">context_composer_cls</span><span class="o">=</span><span class="n">ContextComposer</span><span class="p">,</span>
<span class="p">)</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">compose_session</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">compose_context</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">request_input</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="appending-outputs-to-context">
<h2>Appending outputs to context<a class="headerlink" href="#appending-outputs-to-context" title="Link to this heading">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.context_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_context_manager</span>

<span class="k">async</span> <span class="k">with</span> <span class="n">create_context_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">manager</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">compose_session</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;u1&quot;</span><span class="p">,</span> <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;s1&quot;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">manager</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">event_output</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="available-memory-services">
<h2>Available Memory Services<a class="headerlink" href="#available-memory-services" title="Link to this heading">¶</a></h2>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>MemoryType</p></th>
<th class="head"><p>Import</p></th>
<th class="head text-center"><p>Note</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>InMemoryMemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">agentscope_runtime.engine.services.memory_service</span> <span class="pre">import</span> <span class="pre">InMemoryMemoryService</span></code></p></td>
<td class="text-center"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>RedisMemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">agentscope_runtime.engine.services.redis_memory_service</span> <span class="pre">import</span> <span class="pre">RedisMemoryService</span></code></p></td>
<td class="text-center"><p></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>ReMe.PersonalMemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">reme_ai.service.personal_memory_service</span> <span class="pre">import</span> <span class="pre">PersonalMemoryService</span></code></p></td>
<td class="text-center"><p><a class="reference external" href="https://github.com/modelscope/ReMe">User Guide</a></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>ReMe.TaskMemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">reme_ai.service.task_memory_service</span> <span class="pre">import</span> <span class="pre">TaskMemoryService</span></code></p></td>
<td class="text-center"><p><a class="reference external" href="https://github.com/modelscope/ReMe">User Guide</a></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Mem0MemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">agentscope_runtime.engine.services.mem0_memory_service</span> <span class="pre">import</span> <span class="pre">Mem0MemoryService</span></code></p></td>
<td class="text-center"><p></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>TablestoreMemoryService</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">agentscope_runtime.engine.services.tablestore_memory_service</span> <span class="pre">import</span> <span class="pre">TablestoreMemoryService</span></code></p></td>
<td class="text-center"><p>develop by <a class="reference external" href="https://github.com/aliyun/alibabacloud-tablestore-for-agent-memory/blob/main/python/docs/knowledge_store_tutorial.ipynb">tablestore-for-agent-memory</a></p></td>
</tr>
</tbody>
</table>
</div>
<section id="description">
<h3>Description<a class="headerlink" href="#description" title="Link to this heading">¶</a></h3>
<ul class="simple">
<li><p><strong>InMemoryMemoryService</strong>: An in-memory memory service without persistent storage.</p></li>
<li><p><strong>RedisMemoryService</strong>: A memory service leveraging Redis for persistent storage.</p></li>
<li><p><strong>ReMe.PersonalMemoryService</strong>: ReMe’s personalized memory service (formerly MemoryScope) empowers you to generate, retrieve, and share customized memories. Leveraging advanced LLM, embedding, and vector store technologies, it builds a comprehensive memory system with intelligent, context- and time-aware memory management—seamlessly enabling you to configure and deploy powerful AI agents.</p></li>
<li><p><strong>ReMe.TaskMemoryService</strong>: ReMe’s task-oriented memory service helps you efficiently manage and schedule task-related memories, enhancing both the accuracy and efficiency of task execution. Powered by LLM capabilities, it supports flexible creation, retrieval, update, and deletion of memories across diverse task scenarios—enabling you to effortlessly build and scale robust agent-based task systems.</p></li>
<li><p><strong>Mem0MemoryService</strong>: An intelligent memory service powered by the mem0 platform, providing long-term memory storage and management capabilities. Supports asynchronous operations and automatically extracts, stores, and retrieves key information from conversations, enabling context-aware memory for AI agents. Ideal for complex conversational scenarios and agent applications requiring persistent memory. (For more details, see <a class="reference external" href="https://docs.mem0.ai/platform/quickstart">mem0 platform documentation</a>)</p></li>
<li><p><strong>TablestoreMemoryService</strong>: A memory service based on aliyun tablestore (Tablestore provides Serverless table storage services for massive structured data, and provides a one-stop IoTstore solution for deep optimization of IoT scenarios. It is suitable for structured data storage in scenarios such as massive bills, IM messages, IoT, Internet of Vehicles, risk control, and recommendations, and provides low-cost storage of massive data, millisecond-level online data query and retrieval, and flexible data analysis capabilities), develop by <a class="reference external" href="https://github.com/aliyun/alibabacloud-tablestore-for-agent-memory/blob/main/python/docs/knowledge_store_tutorial.ipynb">tablestore-for-agent-memory</a>. Example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.tablestore_memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">TablestoreMemoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.utils.tablestore_service_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_tablestore_client</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.tablestore_memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">SearchStrategy</span>

<span class="c1"># create tablestore memory service, default search strategy is full text</span>
<span class="n">tablestore_memory_service</span> <span class="o">=</span> <span class="n">TablestoreMemoryService</span><span class="p">(</span>
    <span class="n">tablestore_client</span><span class="o">=</span><span class="n">create_tablestore_client</span><span class="p">(</span>
        <span class="n">end_point</span><span class="o">=</span><span class="s2">&quot;your_endpoint&quot;</span><span class="p">,</span>
        <span class="n">instance_name</span><span class="o">=</span><span class="s2">&quot;your_instance_name&quot;</span><span class="p">,</span>
        <span class="n">access_key_id</span><span class="o">=</span><span class="s2">&quot;your_access_key_id&quot;</span><span class="p">,</span>
        <span class="n">access_key_secret</span><span class="o">=</span><span class="s2">&quot;your_access_key_secret&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>

<span class="c1"># Create a tablestore memory service based on vector retrieval, with DashScopeEmbeddings() as the default embedding model</span>
<span class="n">tablestore_memory_service</span> <span class="o">=</span> <span class="n">TablestoreMemoryService</span><span class="p">(</span>
    <span class="n">tablestore_client</span><span class="o">=</span><span class="n">create_tablestore_client</span><span class="p">(</span>
        <span class="n">end_point</span><span class="o">=</span><span class="s2">&quot;your_endpoint&quot;</span><span class="p">,</span>
        <span class="n">instance_name</span><span class="o">=</span><span class="s2">&quot;your_instance_name&quot;</span><span class="p">,</span>
        <span class="n">access_key_id</span><span class="o">=</span><span class="s2">&quot;your_access_key_id&quot;</span><span class="p">,</span>
        <span class="n">access_key_secret</span><span class="o">=</span><span class="s2">&quot;your_access_key_secret&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">search_strategy</span><span class="o">=</span><span class="n">SearchStrategy</span><span class="o">.</span><span class="n">VECTOR</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
<section id="details-about-session-history-service">
<span id="session-history-service"></span><h2>Details about Session History Service<a class="headerlink" href="#details-about-session-history-service" title="Link to this heading">¶</a></h2>
<p>The Session History Service manages conversation sessions for users, providing a structured way to handle conversation history and message storage. Each session contains the history of a conversation and is uniquely identified by its ID.</p>
<section id="service-overview">
<h3>Service Overview<a class="headerlink" href="#service-overview" title="Link to this heading">¶</a></h3>
<p>The Session Service provides an abstract interface for session management with concrete implementations like <code class="docutils literal notranslate"><span class="pre">InMemorySessionHistoryService</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemorySessionHistoryService</span><span class="p">,</span> <span class="n">Session</span>

<span class="c1"># Create a session service instance</span>
<span class="n">session_history_service</span> <span class="o">=</span> <span class="n">InMemorySessionHistoryService</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="session-object-structure">
<h3>Session Object Structure<a class="headerlink" href="#session-object-structure" title="Link to this heading">¶</a></h3>
<p>Each session is represented by a <code class="docutils literal notranslate"><span class="pre">Session</span></code> object with the following structure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.schemas.agent_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">TextContent</span><span class="p">,</span> <span class="n">Role</span>

<span class="c1"># Session object structure</span>
<span class="n">session_obj</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span>
    <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;session_123&quot;</span><span class="p">,</span>
    <span class="n">user_id</span><span class="o">=</span><span class="s2">&quot;user_456&quot;</span><span class="p">,</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">)]),</span>
        <span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hi there!&quot;</span><span class="p">)]),</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Session ID: </span><span class="si">{</span><span class="n">session_obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User ID: </span><span class="si">{</span><span class="n">session_obj</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Message count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">session_obj</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="core-functionality">
<h3>Core Functionality<a class="headerlink" href="#core-functionality" title="Link to this heading">¶</a></h3>
<section id="creating-sessions">
<h4>Creating Sessions<a class="headerlink" href="#creating-sessions" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">create_session</span></code> method creates new conversation sessions for users:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create a session with auto-generated ID</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;test_user&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created session: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User ID: </span><span class="si">{</span><span class="n">session</span><span class="o">.</span><span class="n">user_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Messages count: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create a session with custom ID</span>
    <span class="n">custom_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span>
        <span class="n">user_id</span><span class="p">,</span>
        <span class="n">session_id</span><span class="o">=</span><span class="s2">&quot;my_custom_session_id&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Custom session ID: </span><span class="si">{</span><span class="n">custom_session</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="retrieving-sessions">
<h4>Retrieving Sessions<a class="headerlink" href="#retrieving-sessions" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">get_session</span></code> method retrieves specific sessions by user ID and session ID:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;u1&quot;</span>
    <span class="c1"># Retrieve an existing session (auto-creates if not exists in in-memory impl)</span>
    <span class="n">retrieved_session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;s1&quot;</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">retrieved_session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>


<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="listing-sessions">
<h4>Listing Sessions<a class="headerlink" href="#listing-sessions" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">list_sessions</span></code> method provides a list of all sessions for a user:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;u_list&quot;</span>
    <span class="c1"># Create multiple sessions</span>
    <span class="n">session1</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">session2</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="c1"># List all sessions (without message history for efficiency)</span>
    <span class="n">listed_sessions</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">list_sessions</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">listed_sessions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span>

    <span class="c1"># Returned sessions don&#39;t include message history</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">listed_sessions</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">s</span><span class="o">.</span><span class="n">messages</span> <span class="o">==</span> <span class="p">[],</span> <span class="s2">&quot;History should be empty in list view&quot;</span>


<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="appending-messages">
<h4>Appending Messages<a class="headerlink" href="#appending-messages" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">append_message</span></code> method adds messages to session history and supports multiple message formats:</p>
<section id="using-dictionary-format">
<h5>Using Dictionary Format<a class="headerlink" href="#using-dictionary-format" title="Link to this heading">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.schemas.agent_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">TextContent</span>


<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;u_append&quot;</span>
    <span class="c1"># Create a session and add messages (dict format is also accepted)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

    <span class="c1"># Append a single message (Message object)</span>
    <span class="n">message1</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">)])</span>
    <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">message1</span><span class="p">)</span>

    <span class="c1"># Verify message was added</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

    <span class="c1"># Append multiple messages at once (mixed formats)</span>
    <span class="n">messages3</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">:</span> <span class="s2">&quot;How are you?&quot;</span><span class="p">}]},</span>
        <span class="n">Message</span><span class="p">(</span><span class="n">role</span><span class="o">=</span><span class="s2">&quot;assistant&quot;</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;I am fine, thank you.&quot;</span><span class="p">)]),</span>
    <span class="p">]</span>
    <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">messages3</span><span class="p">)</span>

    <span class="c1"># Verify all messages were added</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>


<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-built-in-message-format">
<h5>Using Built-in Message Format<a class="headerlink" href="#using-built-in-message-format" title="Link to this heading">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.schemas.agent_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">TextContent</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">,</span> <span class="n">Role</span>

<span class="c1"># Create a session</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;u_append&quot;</span>
<span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="c1"># Add a single message using built-in Message format</span>
<span class="n">message1</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">MessageType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
    <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hello, world!&quot;</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">message1</span><span class="p">)</span>

<span class="c1"># Verify the message was added</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="c1"># Session stores actual Message objects in memory for the in-memory impl</span>
<span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span>
<span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">content</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">text</span> <span class="o">==</span> <span class="s2">&quot;Hello, world!&quot;</span>

<span class="c1"># Add assistant reply message</span>
<span class="n">message2</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">MessageType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
    <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hi there! How can I help you?&quot;</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">message2</span><span class="p">)</span>

<span class="c1"># Add multiple built-in Message format messages at once</span>
<span class="n">messages3</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">MessageType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">USER</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;What&#39;s the weather like?&quot;</span><span class="p">)]</span>
    <span class="p">),</span>
    <span class="n">Message</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">MessageType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span>
        <span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;I don&#39;t have access to real-time weather data.&quot;</span><span class="p">)]</span>
    <span class="p">)</span>
<span class="p">]</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">messages3</span><span class="p">)</span>

<span class="c1"># Verify all messages were added</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="mixed-format-support">
<h5>Mixed Format Support<a class="headerlink" href="#mixed-format-support" title="Link to this heading">¶</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Session service supports mixing dictionary and Message objects</span>
<span class="n">session</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="c1"># Add dictionary format message</span>
<span class="n">dict_message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">dict_message</span><span class="p">)</span>

<span class="c1"># Add Message object</span>
<span class="n">message_obj</span> <span class="o">=</span> <span class="n">Message</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="n">MessageType</span><span class="o">.</span><span class="n">MESSAGE</span><span class="p">,</span>
    <span class="n">role</span><span class="o">=</span><span class="n">Role</span><span class="o">.</span><span class="n">ASSISTANT</span><span class="p">,</span>
    <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Hello! How can I assist you?&quot;</span><span class="p">)]</span>
<span class="p">)</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">append_message</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">message_obj</span><span class="p">)</span>

<span class="c1"># Verify messages were added correctly</span>
<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
<span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;user&quot;</span>  <span class="c1"># Dictionary format</span>
<span class="k">assert</span> <span class="n">session</span><span class="o">.</span><span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;role&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;assistant&quot;</span>  <span class="c1"># Message object converted to dictionary format</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="deleting-sessions">
<h4>Deleting Sessions<a class="headerlink" href="#deleting-sessions" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">delete_session</span></code> method removes specific sessions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create and then delete a session</span>
<span class="n">session_to_delete</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
<span class="n">session_id</span> <span class="o">=</span> <span class="n">session_to_delete</span><span class="o">.</span><span class="n">id</span>

<span class="c1"># Verify session exists</span>
<span class="k">assert</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="c1"># Delete the session</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>

<span class="c1"># Verify session is deleted</span>
<span class="k">assert</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

<span class="c1"># Deleting non-existent sessions doesn&#39;t raise errors</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">delete_session</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="s2">&quot;non_existent_id&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="service-lifecycle">
<h3>Service Lifecycle<a class="headerlink" href="#service-lifecycle" title="Link to this heading">¶</a></h3>
<p>The Session Service follows a simple lifecycle pattern:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start the service (optional for InMemorySessionHistoryService)</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="c1"># Check service health</span>
<span class="n">is_healthy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">health</span><span class="p">()</span>

<span class="c1"># Stop the service (optional for InMemorySessionHistoryService)</span>
<span class="k">await</span> <span class="n">session_history_service</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="implementation-details">
<h3>Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">InMemorySessionHistoryService</span></code> stores data in a nested dictionary structure:</p>
<ul class="simple">
<li><p>Top level: <code class="docutils literal notranslate"><span class="pre">{user_id:</span> <span class="pre">{session_id:</span> <span class="pre">Session}}</span></code></p></li>
<li><p>Each Session object contains id, user_id, and messages list</p></li>
<li><p>Session IDs are auto-generated using UUID if not provided</p></li>
<li><p>Empty or whitespace-only session IDs are replaced with auto-generated IDs</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">TablestoreSessionHistoryService</span></code> stores data in aliyun tablestore, example：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.tablestore_session_history_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">TablestoreSessionHistoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.utils.tablestore_service_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_tablestore_client</span>

<span class="n">tablestore_session_history_service</span> <span class="o">=</span> <span class="n">TablestoreSessionHistoryService</span><span class="p">(</span>
    <span class="n">tablestore_client</span><span class="o">=</span><span class="n">create_tablestore_client</span><span class="p">(</span>
        <span class="n">end_point</span><span class="o">=</span><span class="s2">&quot;your_endpoint&quot;</span><span class="p">,</span>
        <span class="n">instance_name</span><span class="o">=</span><span class="s2">&quot;your_instance_name&quot;</span><span class="p">,</span>
        <span class="n">access_key_id</span><span class="o">=</span><span class="s2">&quot;your_access_key_id&quot;</span><span class="p">,</span>
        <span class="n">access_key_secret</span><span class="o">=</span><span class="s2">&quot;your_access_key_secret&quot;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For production use, consider implementing persistent storage by extending the <code class="docutils literal notranslate"><span class="pre">SessionHistoryService</span></code> abstract base class to support databases or file systems.</p>
</div>
</section>
</section>
<section id="details-about-memory-service">
<span id="memory-service"></span><h2>Details about Memory Service<a class="headerlink" href="#details-about-memory-service" title="Link to this heading">¶</a></h2>
<p>The Memory Service is designed to store and retrieve long-term memory from databases or in-memory storage.
Memory is organized by user ID at the top level, with the message list serving as the elemental values stored in different locations. Additionally, messages can be grouped by session ID.</p>
<section id="id1">
<h3>Service Overview<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h3>
<p>The Memory Service provides an abstract interface for memory management with concrete implementations like <code class="docutils literal notranslate"><span class="pre">InMemoryMemoryService</span></code>.
The following is an example to initialize an in-memory service:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="c1"># Create and start the memory service</span>
<span class="n">memory_service</span> <span class="o">=</span> <span class="n">InMemoryMemoryService</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Core Functionality<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<section id="adding-memory">
<h4>Adding Memory<a class="headerlink" href="#adding-memory" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">add_memory</span></code> method allows you to store messages for a specific user, optionally providing a session ID:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.schemas.agent_schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">TextContent</span>

<span class="c1"># Add memory without a session ID</span>
<span class="n">user_id</span> <span class="o">=</span> <span class="s2">&quot;user1&quot;</span>
<span class="n">messages</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Message</span><span class="p">(</span>
            <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
            <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;hello world&quot;</span><span class="p">)]</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">add_memory</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">messages</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="searching-memory">
<h4>Searching Memory<a class="headerlink" href="#searching-memory" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">search_memory</span></code> method searches for messages based on content keywords:</p>
<p>In the <code class="docutils literal notranslate"><span class="pre">in-memory</span></code> memory service, a simple keyword search algorithm is implemented
to related content based on the query from historical messages.
Other complicated search algorithms could be used to replace the simple method by implementing or overriding the class.</p>
<p>User could use message as a query to search for related content.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">search_query</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Message</span><span class="p">(</span>
        <span class="n">role</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">content</span><span class="o">=</span><span class="p">[</span><span class="n">TextContent</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">)]</span>
    <span class="p">)</span>
<span class="p">]</span>
<span class="n">retrieved</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">search_memory</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">search_query</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="listing-memory">
<h4>Listing Memory<a class="headerlink" href="#listing-memory" title="Link to this heading">¶</a></h4>
<p>list memory method provide a paginated interface for listing memory shown below,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># List memory with pagination</span>
<span class="n">memory_list</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">list_memory</span><span class="p">(</span>
    <span class="n">user_id</span><span class="p">,</span>
    <span class="n">filters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;page_size&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span> <span class="s2">&quot;page_num&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="deleting-memory">
<h4>Deleting Memory<a class="headerlink" href="#deleting-memory" title="Link to this heading">¶</a></h4>
<p>Users can delete memory for specific sessions or entire users:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Delete memory for specific session</span>
<span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">session_id</span><span class="p">)</span>

<span class="c1"># Delete all memory for user</span>
<span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">delete_memory</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id3">
<h3>Service Lifecycle<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h3>
<section id="managing-lifecycle-through-contextmanager">
<h4>Managing Lifecycle through ContextManager<a class="headerlink" href="#managing-lifecycle-through-contextmanager" title="Link to this heading">¶</a></h4>
<p>When using ContextManager, memory service lifecycle is automatically managed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.context_manager</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_context_manager</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_context_manager</span><span class="p">()</span> <span class="k">as</span> <span class="n">context_manager</span><span class="p">:</span>
        <span class="c1"># Register memory service - automatically started</span>
        <span class="n">context_manager</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">InMemoryMemoryService</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;memory&quot;</span><span class="p">)</span>

        <span class="c1"># Service is automatically started and ready to use</span>
        <span class="n">memory_service</span> <span class="o">=</span> <span class="n">context_manager</span><span class="o">.</span><span class="n">memory</span>

        <span class="c1"># Check service health status</span>
        <span class="n">health_status</span> <span class="o">=</span> <span class="k">await</span> <span class="n">context_manager</span><span class="o">.</span><span class="n">health_check</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Memory service health status: </span><span class="si">{</span><span class="n">health_status</span><span class="p">[</span><span class="s1">&#39;memory&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Use service...</span>

    <span class="c1"># When exiting context, service automatically stops and cleans up</span>

<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="service-lifecycle-management">
<h4>Service Lifecycle Management<a class="headerlink" href="#service-lifecycle-management" title="Link to this heading">¶</a></h4>
<p>The Memory Service follows a standard lifecycle pattern and can be managed through <code class="docutils literal notranslate"><span class="pre">start()</span></code>, <code class="docutils literal notranslate"><span class="pre">stop()</span></code>, <code class="docutils literal notranslate"><span class="pre">health()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">agentscope_runtime.engine.services.memory_service</span><span class="w"> </span><span class="kn">import</span> <span class="n">InMemoryMemoryService</span>

<span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create memory service</span>
    <span class="n">memory_service</span> <span class="o">=</span> <span class="n">InMemoryMemoryService</span><span class="p">()</span>

    <span class="c1"># Start service</span>
    <span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># Check service health</span>
    <span class="n">is_healthy</span> <span class="o">=</span> <span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">health</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Service health status: </span><span class="si">{</span><span class="n">is_healthy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Stop service</span>
    <span class="k">await</span> <span class="n">memory_service</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>

<span class="k">await</span> <span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id4">
<h4>Implementation Details<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">InMemoryMemoryService</span></code> stores data in a dictionary structure:</p>
<ul class="simple">
<li><p>Top level: <code class="docutils literal notranslate"><span class="pre">{user_id:</span> <span class="pre">{session_id:</span> <span class="pre">[messages]}}</span></code></p></li>
<li><p>Default session ID is used when no session is specified</p></li>
<li><p>Keyword-based search is case-insensitive</p></li>
<li><p>Messages are stored in chronological order within each session</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For more advanced memory implementations, consider extending the <code class="docutils literal notranslate"><span class="pre">MemoryService</span></code> abstract base class to support persistent storage or vector databases.</p>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./en"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="environment_manager.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Environment Manager</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="manager.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title"><span class="section-number">9. </span>Manager Module</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, Tongyi Lab, Alibaba Inc.
            </div>
            Made with 
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 2025-11-13</div>
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/agentscope-ai/agentscope-runtime" aria-label="GitHub"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
</svg>
</a>
              <a class="muted-link " href="https://discord.gg/eYMpfnkG8h" aria-label="Discord"><svg stroke="currentColor" fill="currentColor" stroke-width="0" t="1753331148815" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5721" width="200" height="200">
    <path d="M723.903423 359.138018c-69.65045-52.952793-136.256577-51.476757-136.256576-51.476757l-6.088649 7.564685c83.027027 25.738378 121.127207 62.085766 121.127207 62.085766a387.459459 387.459459 0 0 0-145.297297-46.956397 418.179459 418.179459 0 0 0-98.340901 1.752793 73.801802 73.801802 0 0 1-7.564684 1.476036 357.385225 357.385225 0 0 0-110.702703 30.258739 278.786306 278.786306 0 0 0-28.782703 13.653333S353.049369 339.488288 440.873514 313.657658l-4.612613-6.088649s-66.513874-1.476036-136.164324 51.476757A654.252973 654.252973 0 0 0 230.630631 642.167928s40.867748 71.126486 148.341621 73.801802c0 0 16.697658-22.694054 31.827027-40.867748-62.085766-18.45045-84.77982-57.565405-84.77982-57.565405a130.998198 130.998198 0 0 0 13.653334 7.564684s0 1.568288 1.476036 1.568289c1.476036 1.476036 3.044324 1.476036 4.52036 3.044324a238.748829 238.748829 0 0 0 34.779099 16.605405 513.199279 513.199279 0 0 0 71.218739 21.218018 350.558559 350.558559 0 0 0 125.555315 0 329.894054 329.894054 0 0 0 69.650451-21.218018A247.328288 247.328288 0 0 0 702.685405 618.09009s-24.262342 39.391712-87.824144 57.565405c13.653333 18.45045 31.827027 39.299459 31.827027 39.29946 107.473874-2.952072 148.341622-73.801802 146.773334-72.602523a654.990991 654.990991 0 0 0-69.558199-283.214414zM421.131532 596.77982a54.705586 54.705586 0 0 1 0-109.042162 54.705586 54.705586 0 0 1 0 109.042162z m177.124324 0a54.705586 54.705586 0 1 1 49.908468-54.521081 52.491532 52.491532 0 0 1-49.908468 54.521081z" p-id="5722"></path><path d="M512 1024A512 512 0 1 1 1024 512 512.645766 512.645766 0 0 1 512 1024z m0-972.892252a461.261261 461.261261 0 1 0 461.261261 461.261261 461.261261 461.261261 0 0 0-461.261261-461.261261z" p-id="5723"></path>
</svg>
</a>
              <a class="muted-link " href="https://qr.dingtalk.com/action/joingroup?code=v1,k1,OmDlBXpjW+I2vWjKDsjvI9dhcXjGZi3bQiojOq3dlDw=&_dt_no_comment=1&origin=11" aria-label="DingTalk"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
    <path d="M512 0C229.205333 0 0 229.205333 0 512s229.205333 512 512 512 512-229.205333 512-512S794.794667 0 512 0z m237.312 480.810667c-1.109333 4.48-3.712 11.093333-7.424 18.986666h0.128l-0.426667 0.682667c-21.504 46.037333-77.610667 136.106667-77.610666 136.106667l-0.298667-0.597334-16.384 28.501334h79.018667l-150.912 200.917333 34.304-136.533333h-62.208l21.589333-90.282667c-17.493333 4.224-38.101333 10.026667-62.592 17.92 0 0-33.109333 19.370667-95.317333-37.333333 0 0-41.984-36.992-17.578667-46.165334 10.410667-3.925333 50.304-8.917333 81.706667-13.226666 42.410667-5.674667 68.48-8.789333 68.48-8.789334s-130.773333 2.005333-161.792-2.901333c-30.976-4.906667-70.4-56.704-78.805334-102.186667 0 0-12.970667-25.002667 27.904-13.226666 40.917333 11.818667 210.005333 46.08 210.005334 46.08S321.109333 411.434667 306.517333 394.922667c-14.634667-16.469333-43.093333-89.770667-39.424-134.869334 0 0 1.621333-11.221333 13.098667-8.192 0 0 162.602667 74.282667 273.792 114.986667 111.104 40.704 207.786667 61.397333 195.328 114.005333z" opacity=".65" p-id="6077"></path>
</svg>
</a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Context Manager</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#services">Services</a><ul>
<li><a class="reference internal" href="#sessionhistoryservice">SessionHistoryService</a></li>
<li><a class="reference internal" href="#memoryservice">MemoryService</a></li>
</ul>
</li>
<li><a class="reference internal" href="#life-cycle-of-a-context-manager">Life-cycle of a context manager</a><ul>
<li><a class="reference internal" href="#initialize-an-instance-directly">Initialize an instance directly</a></li>
<li><a class="reference internal" href="#use-the-async-factory-helper">Use the async factory helper</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contextcomposer">ContextComposer</a></li>
<li><a class="reference internal" href="#appending-outputs-to-context">Appending outputs to context</a></li>
<li><a class="reference internal" href="#available-memory-services">Available Memory Services</a><ul>
<li><a class="reference internal" href="#description">Description</a></li>
</ul>
</li>
<li><a class="reference internal" href="#details-about-session-history-service">Details about Session History Service</a><ul>
<li><a class="reference internal" href="#service-overview">Service Overview</a></li>
<li><a class="reference internal" href="#session-object-structure">Session Object Structure</a></li>
<li><a class="reference internal" href="#core-functionality">Core Functionality</a><ul>
<li><a class="reference internal" href="#creating-sessions">Creating Sessions</a></li>
<li><a class="reference internal" href="#retrieving-sessions">Retrieving Sessions</a></li>
<li><a class="reference internal" href="#listing-sessions">Listing Sessions</a></li>
<li><a class="reference internal" href="#appending-messages">Appending Messages</a><ul>
<li><a class="reference internal" href="#using-dictionary-format">Using Dictionary Format</a></li>
<li><a class="reference internal" href="#using-built-in-message-format">Using Built-in Message Format</a></li>
<li><a class="reference internal" href="#mixed-format-support">Mixed Format Support</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deleting-sessions">Deleting Sessions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service-lifecycle">Service Lifecycle</a></li>
<li><a class="reference internal" href="#implementation-details">Implementation Details</a></li>
</ul>
</li>
<li><a class="reference internal" href="#details-about-memory-service">Details about Memory Service</a><ul>
<li><a class="reference internal" href="#id1">Service Overview</a></li>
<li><a class="reference internal" href="#id2">Core Functionality</a><ul>
<li><a class="reference internal" href="#adding-memory">Adding Memory</a></li>
<li><a class="reference internal" href="#searching-memory">Searching Memory</a></li>
<li><a class="reference internal" href="#listing-memory">Listing Memory</a></li>
<li><a class="reference internal" href="#deleting-memory">Deleting Memory</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id3">Service Lifecycle</a><ul>
<li><a class="reference internal" href="#managing-lifecycle-through-contextmanager">Managing Lifecycle through ContextManager</a></li>
<li><a class="reference internal" href="#service-lifecycle-management">Service Lifecycle Management</a></li>
<li><a class="reference internal" href="#id4">Implementation Details</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/documentation_options.js?v=a8e58a58"></script>
    <script src="../_static/doctools.js?v=9a2dae69"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script src="../_static/language.js?v=c79991d2"></script>
    </body>
</html>